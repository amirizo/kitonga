<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitonga Wi-Fi Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 350px;
            text-align: center;
        }
        .logo {
            font-size: 48px;
            margin-bottom: 10px;
        }
        h1 {
            color: #1976d2;
            margin: 0 0 5px 0;
            font-size: 24px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="text"]:focus, input[type="password"]:focus {
            border-color: #1976d2;
            outline: none;
        }
        .btn {
            width: 100%;
            padding: 12px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .btn:hover {
            background: #1565c0;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .register-btn {
            width: 100%;
            padding: 10px;
            background: white;
            color: #1976d2;
            border: 2px solid #1976d2;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        .register-btn:hover {
            background: #1976d2;
            color: white;
        }
        .error {
            background: #ffebee;
            border: 1px solid #e57373;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        .success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        .loading {
            display: none;
            margin: 20px 0;
        }
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #999;
            font-size: 12px;
        }
        .divider {
            margin: 20px 0;
            text-align: center;
            color: #999;
            font-size: 14px;
        }
        .divider:before {
            content: '';
            display: inline-block;
            width: 30%;
            height: 1px;
            background: #ddd;
            vertical-align: middle;
            margin-right: 10px;
        }
        .divider:after {
            content: '';
            display: inline-block;
            width: 30%;
            height: 1px;
            background: #ddd;
            vertical-align: middle;
            margin-left: 10px;
        }
        .debug-info {
            display: none;
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            font-size: 11px;
            text-align: left;
            border-radius: 5px;
            word-break: break-all;
        }
        @media (max-width: 400px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ðŸ“¶</div>
        <h1 id="businessName">Kitonga Wi-Fi</h1>
        <p class="subtitle">Connect to high-speed internet</p>

        <div id="error" class="error"></div>
        <div id="success" class="success"></div>

        <form name="login" method="post" onsubmit="return doLogin()">
            <div class="form-group">
                <label for="username">Phone Number:</label>
                <input type="text" name="username" id="username" placeholder="+255700123456" required>
            </div>
            
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" name="password" id="password" placeholder="Enter your phone number" required>
            </div>
            
            <input type="hidden" name="dst" value="">
            <input type="hidden" name="popup" value="">
            
            <button type="submit" class="btn" id="loginBtn">Connect to Internet</button>
        </form>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p id="loadingText">Verifying your access...</p>
        </div>

        <div class="divider">New user?</div>
        
        <button type="button" class="register-btn" onclick="openRegistration()">
            Register for Wi-Fi Access
        </button>

        <div class="footer">
            <p><strong>Powered by Kitonga Wi-Fi</strong></p>
            <p>For support visit kitonga.klikcell.com</p>
        </div>
        
        <div id="debugInfo" class="debug-info"></div>
    </div>

    <script>
        // API Configuration - CHANGE THIS TO YOUR VPS URL
        // For production:
        // var API_BASE_URL = 'https://api.kitonga.klikcell.com';
        // var FRONTEND_URL = 'https://kitonga.klikcell.com/portal/';
        
        // For local testing:
        var API_BASE_URL = 'http://127.0.0.1:8000';
        var FRONTEND_URL = 'http://localhost:3000/portal/';
        
        // Debug mode - set to true to see debug info
        var DEBUG_MODE = true;

        // Get URL parameters from MikroTik
        function getParams() {
            var params = {};
            var search = window.location.search.substring(1);
            if (search) {
                var pairs = search.split('&');
                for (var i = 0; i < pairs.length; i++) {
                    var pair = pairs[i].split('=');
                    var key = decodeURIComponent(pair[0]);
                    var value = decodeURIComponent(pair[1] || '');
                    // Handle both dash and underscore versions
                    params[key] = value;
                    params[key.replace(/-/g, '_')] = value;
                }
            }
            return params;
        }

        // Show error message
        function showError(msg) {
            var errorDiv = document.getElementById('error');
            errorDiv.innerHTML = msg;
            errorDiv.style.display = 'block';
            document.getElementById('success').style.display = 'none';
        }

        // Show success message
        function showSuccess(msg) {
            var successDiv = document.getElementById('success');
            successDiv.innerHTML = msg;
            successDiv.style.display = 'block';
            document.getElementById('error').style.display = 'none';
        }

        // Hide messages
        function hideMessages() {
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';
        }

        // Show loading
        function showLoading(text) {
            document.querySelector('form').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingText').textContent = text || 'Verifying your access...';
        }

        // Hide loading
        function hideLoading() {
            document.querySelector('form').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        // Debug log
        function debugLog(msg) {
            console.log('[Kitonga] ' + msg);
            if (DEBUG_MODE) {
                var debugDiv = document.getElementById('debugInfo');
                debugDiv.style.display = 'block';
                debugDiv.innerHTML += msg + '<br>';
            }
        }

        // Open registration page
        function openRegistration() {
            var params = getParams();
            var routerId = params['router-id'] || params['router_id'] || params['routerid'] || '';
            var url = 'https://kitonga.klikcell.com/';
            if (routerId) {
                url += '?router=' + encodeURIComponent(routerId);
            }
            window.open(url, '_blank');
        }

        // Normalize phone number to 255 format
        function normalizePhone(phone) {
            phone = phone.replace(/[\s\-\(\)]/g, '');
            if (phone.startsWith('+')) {
                phone = phone.substring(1);
            }
            if (phone.startsWith('0')) {
                phone = '255' + phone.substring(1);
            }
            return phone;
        }

        // Handle form submission
        function doLogin() {
            var username = document.getElementById('username').value.trim();
            var password = document.getElementById('password').value.trim();
            var params = getParams();

            // Validation
            if (!username || !password) {
                showError('Please enter both phone number and password');
                return false;
            }

            // Phone validation
            if (!username.match(/^\+?[0-9]{9,15}$/)) {
                showError('Please enter a valid phone number (e.g. +255700123456)');
                return false;
            }

            hideMessages();
            showLoading('Verifying your access...');

            // Get MikroTik parameters
            var mac = params['mac'] || params['mac-address'] || '';
            var ip = params['ip'] || params['ip-address'] || '';
            var routerId = params['router-id'] || params['router_id'] || params['routerid'] || '';
            var linkLogin = params['link-login'] || params['link_login'] || '';
            var linkOrig = params['link-orig'] || params['link_orig'] || params['dst'] || '';
            var chapId = params['chap-id'] || params['chap_id'] || '';
            var chapChallenge = params['chap-challenge'] || params['chap_challenge'] || '';

            debugLog('MAC: ' + mac + ', IP: ' + ip + ', Router: ' + routerId);
            debugLog('Link-login: ' + linkLogin);

            // Normalize phone number
            var normalizedPhone = normalizePhone(username);
            debugLog('Phone: ' + username + ' -> ' + normalizedPhone);

            // Step 1: Verify access with backend API
            verifyAccessWithBackend(normalizedPhone, mac, ip, routerId, function(result) {
                if (result.success && result.access_granted) {
                    // User has valid access - now submit to MikroTik
                    showLoading('Access verified! Connecting to internet...');
                    debugLog('Access granted, submitting to MikroTik');
                    
                    if (linkLogin) {
                        // Submit credentials to MikroTik hotspot
                        submitToMikrotik(normalizedPhone, normalizedPhone, linkLogin, chapId, chapChallenge, linkOrig);
                    } else {
                        // No link-login, just show success
                        hideLoading();
                        showSuccess('Access granted! You should now have internet access. Try refreshing or opening a new page.');
                    }
                } else {
                    // Access denied
                    hideLoading();
                    var reason = result.denial_reason || result.message || 'Access denied';
                    showError(reason + '<br><br>Please make a payment or redeem a voucher to get access.');
                    debugLog('Access denied: ' + reason);
                }
            });
            
            return false;
        }

        // Verify access with backend API
        function verifyAccessWithBackend(phone, mac, ip, routerId, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', API_BASE_URL + '/api/verify/', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.timeout = 15000;

            xhr.onload = function() {
                try {
                    var response = JSON.parse(xhr.responseText);
                    debugLog('API Response: ' + JSON.stringify(response).substring(0, 200));
                    callback({
                        success: true,
                        access_granted: response.access_granted,
                        denial_reason: response.denial_reason,
                        user: response.user,
                        mikrotik_auto_login: response.mikrotik_auto_login
                    });
                } catch (e) {
                    debugLog('Parse error: ' + e.message);
                    callback({
                        success: false,
                        access_granted: false,
                        denial_reason: 'Failed to verify access. Please try again.'
                    });
                }
            };

            xhr.onerror = function() {
                debugLog('Network error');
                callback({
                    success: false,
                    access_granted: false,
                    denial_reason: 'Network error. Please check your connection.'
                });
            };

            xhr.ontimeout = function() {
                debugLog('Request timeout');
                callback({
                    success: false,
                    access_granted: false,
                    denial_reason: 'Connection timeout. Please try again.'
                });
            };

            var payload = JSON.stringify({
                phone_number: phone,
                mac_address: mac,
                ip_address: ip,
                router_id: routerId
            });
            
            debugLog('Sending to API: ' + payload);
            xhr.send(payload);
        }

        // Submit to MikroTik hotspot login
        function submitToMikrotik(username, password, loginUrl, chapId, chapChallenge, dst) {
            try {
                debugLog('Submitting to MikroTik: ' + loginUrl);
                
                // Build form
                var form = document.createElement('form');
                form.method = 'post';
                form.action = loginUrl;

                // Add fields
                var fields = {
                    'username': username,
                    'password': password
                };

                // Add CHAP if available (for CHAP authentication)
                if (chapId) {
                    fields['chap-id'] = chapId;
                }
                if (chapChallenge) {
                    fields['chap-challenge'] = chapChallenge;
                }

                // Add destination
                if (dst) {
                    fields['dst'] = dst;
                }

                // Create hidden inputs
                for (var key in fields) {
                    var input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = fields[key];
                    form.appendChild(input);
                }

                showSuccess('Access granted! Connecting...');
                
                // Submit form after brief delay
                document.body.appendChild(form);
                setTimeout(function() {
                    form.submit();
                }, 500);
                
            } catch (error) {
                debugLog('MikroTik submit error: ' + error.message);
                hideLoading();
                showError('Connection failed. Please try again or contact support.');
            }
        }

        // Initialize page
        function init() {
            var params = getParams();
            
            debugLog('URL params: ' + JSON.stringify(params));

            // Handle MikroTik error messages
            if (params.error) {
                var errorMsg = 'Authentication failed';
                switch(params.error) {
                    case 'invalid username or password':
                    case 'invalid-user':
                        errorMsg = 'Invalid username or password. Please check your phone number.';
                        break;
                    case 'user-session-limit':
                        errorMsg = 'Maximum device limit reached. Please disconnect another device.';
                        break;
                    case 'user-expired':
                        errorMsg = 'Your access has expired. Please make a new payment.';
                        break;
                    case 'radius-no-response':
                        errorMsg = 'Server connection error. Please try again.';
                        break;
                    default:
                        errorMsg = 'Login failed: ' + params.error;
                }
                showError(errorMsg);
            }

            // Set hidden fields
            var dstInput = document.querySelector('input[name="dst"]');
            var popupInput = document.querySelector('input[name="popup"]');
            if (dstInput) dstInput.value = params.dst || params['link-orig'] || '';
            if (popupInput) popupInput.value = params.popup || '';

            // Auto-fill password with username (phone as password)
            document.getElementById('username').oninput = function() {
                document.getElementById('password').value = this.value;
            };

            // Focus username
            document.getElementById('username').focus();
            
            // Show debug info if enabled
            if (DEBUG_MODE) {
                document.getElementById('debugInfo').style.display = 'block';
                debugLog('Page loaded');
                debugLog('API URL: ' + API_BASE_URL);
            }
        }

        // Run on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
