<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kitonga Wi-Fi Login</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 350px;
        text-align: center;
      }
      .logo {
        font-size: 48px;
        margin-bottom: 10px;
      }
      h1 {
        color: #1976d2;
        margin: 0 0 5px 0;
        font-size: 24px;
      }
      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }
      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }
      input[type='text'],
      input[type='password'] {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
      }
      input[type='text']:focus,
      input[type='password']:focus {
        border-color: #1976d2;
        outline: none;
      }
      .btn {
        width: 100%;
        padding: 12px;
        background: #1976d2;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 20px;
      }
      .btn:hover {
        background: #1565c0;
      }
      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .register-btn {
        width: 100%;
        padding: 10px;
        background: white;
        color: #1976d2;
        border: 2px solid #1976d2;
        border-radius: 5px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
      }
      .register-btn:hover {
        background: #1976d2;
        color: white;
      }
      .error {
        background: #ffebee;
        border: 1px solid #e57373;
        color: #c62828;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
      }
      .success {
        background: #e8f5e8;
        border: 1px solid #4caf50;
        color: #2e7d32;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
      }
      .loading {
        display: none;
        margin: 20px 0;
      }
      .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #1976d2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .footer {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
        color: #999;
        font-size: 12px;
      }
      .divider {
        margin: 20px 0;
        text-align: center;
        color: #999;
        font-size: 14px;
      }
      .divider:before {
        content: '';
        display: inline-block;
        width: 30%;
        height: 1px;
        background: #ddd;
        vertical-align: middle;
        margin-right: 10px;
      }
      .divider:after {
        content: '';
        display: inline-block;
        width: 30%;
        height: 1px;
        background: #ddd;
        vertical-align: middle;
        margin-left: 10px;
      }
      @media (max-width: 400px) {
        .container {
          padding: 20px;
          margin: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo">üì∂</div>
      <h1>Kitonga</h1>
      <p class="subtitle">Connect to high-speed internet</p>

      <div id="error" class="error"></div>
      <div id="success" class="success"></div>

      <form name="login" method="post" onsubmit="return doLogin()">
        <div class="form-group">
          <label for="username">Phone Number:</label>
          <input type="text" name="username" id="username" placeholder="+255700123456" required />
        </div>

        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" name="password" id="password" placeholder="Enter your phone number" required />
        </div>

        <input type="hidden" name="dst" value="" />
        <input type="hidden" name="popup" value="" />

        <button type="submit" class="btn" id="loginBtn">Connect to Internet</button>
      </form>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Connecting you to the internet...</p>
      </div>

      <div class="divider">New user?</div>

      <button type="button" class="register-btn" onclick="openRegistration()">Register for Wi-Fi Access</button>

      <div class="divider">Already registered?</div>

      <button type="button" class="register-btn" onclick="openStatusPage()" style="border-color: #4caf50; color: #4caf50">üîç Check Access Status / Redeem Voucher</button>

      <div class="footer">
        <p><strong>Powered by Kitonga Wi-Fi</strong></p>
        <p>For support visit kitonga.klikcell.com</p>
        <p id="router-info" style="font-size: 10px; color: #999; margin-top: 10px"></p>
      </div>
    </div>

    <script>
      // =====================================================================
      // ROUTER CONFIGURATION - CHANGE THIS FOR EACH MIKROTIK ROUTER
      // =====================================================================
      // Find your Router ID in Kitonga Admin: https://kitonga.klikcell.com/admin/
      // Go to: Billing ‚Üí Routers ‚Üí Copy the ID number
      const ROUTER_ID = 8 // <-- CHANGE THIS TO YOUR ROUTER ID
      // =====================================================================

      // API Configuration
      const API_BASE_URL = 'https://api.kitonga.klikcell.com/api'
      const MAIN_PORTAL_URL = 'https://kitonga.klikcell.com'

      // Phone number utilities
      function normalizePhoneNumber(phone) {
        const digits = phone.replace(/\D/g, '')

        if (digits.startsWith('255')) {
          return digits
        } else if (digits.startsWith('0')) {
          return '255' + digits.slice(1)
        } else if (digits.length === 9) {
          return '255' + digits
        }

        return digits
      }

      function validateTanzaniaPhoneNumber(phone) {
        const normalized = normalizePhoneNumber(phone)
        return /^255[67]\d{8}$/.test(normalized)
      }

      function formatPhoneForDisplay(phone) {
        const normalized = normalizePhoneNumber(phone)
        if (!/^255[67]\d{8}$/.test(normalized)) return phone
        return '+255 ' + normalized.slice(3, 6) + ' ' + normalized.slice(6, 9) + ' ' + normalized.slice(9)
      }

      // Get URL parameters (MikroTik captive portal passes these)
      // Standard MikroTik params: mac, ip, username, link-login, link-orig, error, chap-id, chap-challenge
      // Custom params: router-id (from hotspot profile login-url), tenant
      function getParams() {
        var params = {}
        var search = window.location.search.substring(1)
        if (search) {
          var pairs = search.split('&')
          for (var i = 0; i < pairs.length; i++) {
            var pair = pairs[i].split('=')
            params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '')
          }
        }
        return params
      }

      // Get router_id - PRIORITY: 1. Configured ROUTER_ID, 2. URL params
      // The ROUTER_ID constant at the top of this file is the primary source
      // URL params are fallback (in case MikroTik passes router-id in URL)
      function getRouterId() {
        // First, use the configured ROUTER_ID constant (set at top of file)
        if (typeof ROUTER_ID !== 'undefined' && ROUTER_ID) {
          return ROUTER_ID.toString()
        }
        // Fallback: check URL params (for backwards compatibility)
        const params = getParams()
        return params['router_id'] || params['router-id'] || params['routerid'] || null
      }

      // Get tenant slug from URL params (fallback if router_id not available)
      function getTenantSlug() {
        const params = getParams()
        return params['tenant'] || params['tenant_slug'] || null
      }

      // Build portal URL with all required parameters for tenant isolation
      function buildPortalUrl(basePath) {
        const params = getParams()
        const ip = params['ip'] || params['client-ip'] || ''
        const mac = params['mac'] || params['mac-address'] || ''
        const routerId = getRouterId() // Uses ROUTER_ID constant
        const tenant = getTenantSlug()

        let url = MAIN_PORTAL_URL + basePath + '?ip=' + encodeURIComponent(ip) + '&mac=' + encodeURIComponent(mac)

        // IMPORTANT: Always include router_id for proper tenant isolation
        if (routerId) {
          url += '&router_id=' + encodeURIComponent(routerId)
        }
        // Include tenant as fallback
        if (tenant) {
          url += '&tenant=' + encodeURIComponent(tenant)
        }
        return url
      }

      // Show error message
      function showError(msg) {
        var errorDiv = document.getElementById('error')
        errorDiv.innerHTML = msg
        errorDiv.style.display = 'block'
        document.getElementById('success').style.display = 'none'
      }

      // Show success message
      function showSuccess(msg) {
        var successDiv = document.getElementById('success')
        successDiv.innerHTML = msg
        successDiv.style.display = 'block'
        document.getElementById('error').style.display = 'none'
      }

      // Hide messages
      function hideMessages() {
        document.getElementById('error').style.display = 'none'
        document.getElementById('success').style.display = 'none'
      }

      // Show loading
      function showLoading() {
        document.querySelector('form').style.display = 'none'
        document.getElementById('loading').style.display = 'block'
      }

      // Hide loading
      function hideLoading() {
        document.querySelector('form').style.display = 'block'
        document.getElementById('loading').style.display = 'none'
      }

      // Open registration page (portal with welcome/payment screens)
      function openRegistration() {
        window.open(buildPortalUrl('/portal'), '_blank')
      }

      // Open status/verify page
      function openStatusPage() {
        window.open(buildPortalUrl('/status'), '_blank')
      }

      // Verify user access via Kitonga API (uses /verify/ endpoint)
      // CRITICAL: Passes router_id for proper tenant isolation and router-specific access grant
      async function verifyUserAccess(phone) {
        const params = getParams()
        const ip = params['ip'] || params['client-ip'] || null
        const mac = params['mac'] || params['mac-address'] || null
        const routerId = getRouterId()
        const tenant = getTenantSlug()

        const requestBody = {
          phone_number: phone,
          mac_address: mac,
          ip_address: ip
        }

        // IMPORTANT: router_id is CRITICAL for multi-tenant SaaS
        // It tells the backend which router (and therefore which tenant) this request is for
        // This ensures:
        // 1. User is created/found within correct tenant
        // 2. Hotspot user is created on the correct router
        // 3. Access logs are associated with correct tenant
        if (routerId) {
          requestBody.router_id = parseInt(routerId, 10)
          console.log('üì° Router ID:', routerId, '- Using for tenant isolation')
        } else {
          console.warn('‚ö†Ô∏è No router_id provided - tenant isolation may not work correctly')
        }

        // Tenant slug as fallback (less reliable than router_id)
        if (tenant) {
          requestBody.tenant = tenant
        }

        console.log('üîç Verifying access:', requestBody)

        try {
          const response = await fetch(API_BASE_URL + '/verify/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
          })

          const data = await response.json().catch(() => ({}))

          if (!response.ok) {
            throw new Error(data.message || data.denial_reason || 'Verification failed')
          }

          // Check if access is granted
          if (!data.access_granted) {
            throw new Error(data.denial_reason || 'Access not granted. Please register or renew your bundle.')
          }

          return data
        } catch (error) {
          throw error
        }
      }

      // Handle form submission
      async function doLogin() {
        var rawPhone = document.getElementById('username').value.trim()
        var password = document.getElementById('password').value.trim()
        var params = getParams()

        // Validation
        if (!rawPhone || !password) {
          showError('Please enter both phone number and password')
          return false
        }

        const normalizedPhone = normalizePhoneNumber(rawPhone)

        if (!validateTanzaniaPhoneNumber(rawPhone)) {
          showError('Please enter a valid Tanzanian phone number (e.g. 07XXXXXXXX or +2557XXXXXXXX)')
          return false
        }

        hideMessages()
        showLoading()

        // Check if this is a MikroTik login page
        const hasMikrotikLogin = params['link-login'] || params['link_login']

        if (!hasMikrotikLogin) {
          // Not coming from Mikrotik ‚Äì send user to main portal
          hideLoading()
          showError('Please complete registration at our main portal first.')
          setTimeout(function () {
            const routerId = getRouterId()
            const mac = params['mac'] || params['mac-address'] || ''
            const ip = params['ip'] || params['client-ip'] || ''
            let redirectUrl = MAIN_PORTAL_URL + '/portal?phone=' + encodeURIComponent(normalizedPhone)
            if (routerId) {
              redirectUrl += '&router_id=' + encodeURIComponent(routerId)
            }
            if (mac) {
              redirectUrl += '&mac=' + encodeURIComponent(mac)
            }
            if (ip) {
              redirectUrl += '&ip=' + encodeURIComponent(ip)
            }
            window.location.href = redirectUrl
          }, 2000)
          return false
        }

        try {
          // 1) Verify user access via Kitonga API (uses /verify/ endpoint)
          const verifyResponse = await verifyUserAccess(normalizedPhone)

          // 2) Check if MikroTik auto-login was performed by backend
          if (verifyResponse.mikrotik_auto_login && verifyResponse.mikrotik_auto_login.success) {
            showSuccess('‚úÖ Access granted! Auto-connecting you to the internet...')
            // Auto-login was successful, redirect to destination or reload
            setTimeout(function () {
              const dst = params['dst'] || params['link-orig'] || ''
              if (dst) {
                window.location.href = dst
              } else {
                window.location.reload()
              }
            }, 2000)
            return false
          }

          // 3) If no auto-login, proceed with manual Mikrotik login
          showSuccess('Authentication successful! Connecting you to the internet...')

          // Get credentials from verify response or use normalized phone
          const mikrotikUsername = verifyResponse.mikrotik_connection?.username || normalizedPhone
          const mikrotikPassword = verifyResponse.mikrotik_connection?.password || normalizedPhone

          setTimeout(function () {
            submitToMikrotik(mikrotikUsername, mikrotikPassword, params)
          }, 1500)
        } catch (error) {
          console.error('Verify access error:', error)
          hideLoading()

          // Check for specific error types
          const errorMsg = (error && error.message) || 'Unable to connect. Please make sure your number is registered and try again.'

          if (errorMsg.includes('expired') || errorMsg.includes('renew')) {
            showError('Your access has expired. <a href="javascript:openStatusPage()">Click here to renew</a> or <a href="javascript:openRegistration()">buy a new bundle</a>.')
          } else if (errorMsg.includes('not registered') || errorMsg.includes('not found')) {
            showError('Phone number not registered. <a href="javascript:openRegistration()">Click here to register</a>.')
          } else if (errorMsg.includes('device') || errorMsg.includes('limit')) {
            showError('Device limit reached. <a href="javascript:openStatusPage()">Manage your devices here</a>.')
          } else {
            showError(errorMsg)
          }
        }

        return false
      }

      // Submit to MikroTik
      function submitToMikrotik(username, password, params) {
        try {
          var loginUrl = params['link-login'] || params['link_login']

          if (!loginUrl) {
            throw new Error('No login URL available')
          }

          // Build form
          var form = document.createElement('form')
          form.method = 'post'
          form.action = loginUrl

          // Add fields
          var fields = {
            username: username,
            password: password
          }

          // Add CHAP if available
          if (params['chap-id'] || params['chap_id']) {
            fields['chap_id'] = params['chap-id'] || params['chap_id']
          }
          if (params['chap-challenge'] || params['chap_challenge']) {
            fields['chap_challenge'] = params['chap-challenge'] || params['chap_challenge']
          }

          // Add other parameters
          if (params['dst']) fields['dst'] = params['dst']
          if (params['popup']) fields['popup'] = params['popup']

          // Create hidden inputs
          for (var key in fields) {
            if (!Object.prototype.hasOwnProperty.call(fields, key)) continue
            var input = document.createElement('input')
            input.type = 'hidden'
            input.name = key
            input.value = fields[key]
            form.appendChild(input)
          }

          // Submit form
          document.body.appendChild(form)
          setTimeout(function () {
            form.submit()
          }, 500)
        } catch (error) {
          hideLoading()
          showError('Connection to hotspot failed. Please try again.')
          console.error('Login error:', error)
        }
      }

      // Initialize page
      function init() {
        var params = getParams()

        // Handle errors from Mikrotik
        if (params.error) {
          var errorMsg = 'Authentication failed'
          switch (params.error) {
            case 'invalid-user':
              errorMsg = 'Invalid phone number or password. <a href="javascript:openRegistration()">Register here</a> if you are a new user.'
              break
            case 'user-session-limit':
              errorMsg = 'Maximum device limit reached. <a href="javascript:openStatusPage()">Manage your devices</a>.'
              break
            case 'user-expired':
              errorMsg = 'Your access has expired. <a href="javascript:openStatusPage()">Renew your bundle here</a>.'
              break
            case 'user-disabled':
              errorMsg = 'Your account is disabled. Please contact support.'
              break
            case 'user-not-found':
              errorMsg = 'Account not found. <a href="javascript:openRegistration()">Register for Wi-Fi access</a>.'
              break
            default:
              errorMsg = 'Login failed: ' + params.error
          }
          showError(errorMsg)
        }

        // Set hidden fields
        var dstInput = document.querySelector('input[name="dst"]')
        var popupInput = document.querySelector('input[name="popup"]')
        if (dstInput) dstInput.value = params.dst || ''
        if (popupInput) popupInput.value = params.popup || ''

        // Auto-fill password with phone number
        var usernameInput = document.getElementById('username')
        var passwordInput = document.getElementById('password')

        usernameInput.oninput = function () {
          passwordInput.value = this.value
        }

        // If phone is passed from portal, prefill it
        if (params.phone) {
          usernameInput.value = params.phone
          passwordInput.value = params.phone
        }

        // Show router info if available (for debugging/support)
        var routerId = getRouterId()
        if (routerId) {
          console.log('üì° Connected to router ID:', routerId)
          // Show in footer for verification
          var routerInfoEl = document.getElementById('router-info')
          if (routerInfoEl) {
            routerInfoEl.textContent = 'Router: ' + routerId
          }
        }

        // Focus username
        usernameInput.focus()
      }

      // Run on page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init)
      } else {
        init()
      }
    </script>
  </body>
</html>
