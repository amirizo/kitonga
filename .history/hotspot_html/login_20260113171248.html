<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kitonga Wi-Fi Login</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 350px;
        text-align: center;
      }
      .logo {
        font-size: 48px;
        margin-bottom: 10px;
      }
      h1 {
        color: #1976d2;
        margin: 0 0 5px 0;
        font-size: 24px;
      }
      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }
      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }
      input[type='text'],
      input[type='password'] {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
      }
      input[type='text']:focus,
      input[type='password']:focus,
      input[type='tel']:focus {
        border-color: #1976d2;
        outline: none;
      }
      input[type='tel'] {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
      }
      .phone-input {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: white;
        overflow: hidden;
      }
      .phone-input:focus-within {
        border-color: #1976d2;
      }
      .phone-prefix {
        background: #f5f5f5;
        padding: 12px 15px;
        font-size: 16px;
        font-weight: bold;
        color: #333;
        border-right: 1px solid #ddd;
        white-space: nowrap;
      }
      .phone-input input[type='tel'] {
        border: none;
        border-radius: 0;
        flex: 1;
      }
      .phone-input input[type='tel']:focus {
        border: none;
        outline: none;
      }
      .btn {
        width: 100%;
        padding: 12px;
        background: #1976d2;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 20px;
      }
      .btn:hover {
        background: #1565c0;
      }
      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .register-btn {
        width: 100%;
        padding: 10px;
        background: white;
        color: #1976d2;
        border: 2px solid #1976d2;
        border-radius: 5px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
      }
      .register-btn:hover {
        background: #1976d2;
        color: white;
      }
      .error {
        background: #ffebee;
        border: 1px solid #e57373;
        color: #c62828;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
      }
      .success {
        background: #e8f5e8;
        border: 1px solid #4caf50;
        color: #2e7d32;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
      }
      .loading {
        display: none;
        margin: 20px 0;
      }
      .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #1976d2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .footer {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
        color: #999;
        font-size: 12px;
      }
      .divider {
        margin: 20px 0;
        text-align: center;
        color: #999;
        font-size: 14px;
      }
      .divider:before {
        content: '';
        display: inline-block;
        width: 30%;
        height: 1px;
        background: #ddd;
        vertical-align: middle;
        margin-right: 10px;
      }
      .divider:after {
        content: '';
        display: inline-block;
        width: 30%;
        height: 1px;
        background: #ddd;
        vertical-align: middle;
        margin-left: 10px;
      }
      .debug-info {
        display: none;
        background: #f5f5f5;
        border: 1px solid #ddd;
        padding: 10px;
        margin-top: 10px;
        font-size: 11px;
        text-align: left;
        border-radius: 5px;
        word-break: break-all;
      }
      @media (max-width: 400px) {
        .container {
          padding: 20px;
          margin: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo">ðŸ“¶</div>
      <h1 id="businessName">Kitonga Wi-Fi</h1>
      <p class="subtitle">Connect to high-speed internet</p>

      <div id="error" class="error"></div>
      <div id="success" class="success"></div>

      <form name="login" method="post" onsubmit="return doLogin()">
        <div class="form-group">
          <label for="username">Phone Number:</label>
          <div class="phone-input">
            <span class="phone-prefix">+255</span>
            <input type="tel" name="username" id="username" placeholder="712345678" required maxlength="9" pattern="[0-9]{9}" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 9); document.getElementById('password').value = '255' + this.value;" />
          </div>
          <small style="color: #666; font-size: 12px; margin-top: 5px; display: block">Enter 9 digits after +255 (e.g., 712345678)</small>
        </div>

        <input type="hidden" name="password" id="password" value="" />
        <input type="hidden" name="dst" value="" />
        <input type="hidden" name="popup" value="" />

        <button type="submit" class="btn" id="loginBtn">Connect to Internet</button>
      </form>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p id="loadingText">Verifying your access...</p>
      </div>

      <div class="divider">New user?</div>

      <button type="button" class="register-btn" onclick="openRegistration()">Register for Wi-Fi Access</button>

      <div class="footer">
        <p><strong>Powered by Kitonga Wi-Fi</strong></p>
        <p>For support visit kitonga.klikcell.com</p>
      </div>

      <div id="debugInfo" class="debug-info"></div>
    </div>

    <script>
      // API Configuration
      // Production URLs (LIVE):
      var API_BASE_URL = 'https://api.kitonga.klikcell.com'
      var FRONTEND_URL = 'https://kitonga.klikcell.com/portal/'

      // For local testing (uncomment these and comment out production URLs above):
      // var API_BASE_URL = 'http://localhost:8000'
      // var FRONTEND_URL = 'http://localhost:3000/portal/'

      // Debug mode - set to true to see debug info, false for production
      var DEBUG_MODE = true  // Set to false after testing

      // Store router_id globally for use across functions
      var ROUTER_ID = ''

      // Get URL parameters from MikroTik
      function getParams() {
        var params = {}
        var search = window.location.search.substring(1)
        if (search) {
          var pairs = search.split('&')
          for (var i = 0; i < pairs.length; i++) {
            var pair = pairs[i].split('=')
            var key = decodeURIComponent(pair[0])
            var value = decodeURIComponent(pair[1] || '')
            // Handle both dash and underscore versions
            params[key] = value
            params[key.replace(/-/g, '_')] = value
          }
        }
        // Store router_id globally
        ROUTER_ID = params['router-id'] || params['router_id'] || params['routerid'] || ''
        return params
      }

      // Show error message
      function showError(msg) {
        var errorDiv = document.getElementById('error')
        errorDiv.innerHTML = msg
        errorDiv.style.display = 'block'
        document.getElementById('success').style.display = 'none'
      }

      // Show success message
      function showSuccess(msg) {
        var successDiv = document.getElementById('success')
        successDiv.innerHTML = msg
        successDiv.style.display = 'block'
        document.getElementById('error').style.display = 'none'
      }

      // Hide messages
      function hideMessages() {
        document.getElementById('error').style.display = 'none'
        document.getElementById('success').style.display = 'none'
      }

      // Show loading
      function showLoading(text) {
        document.querySelector('form').style.display = 'none'
        document.getElementById('loading').style.display = 'block'
        document.getElementById('loadingText').textContent = text || 'Verifying your access...'
      }

      // Hide loading
      function hideLoading() {
        document.querySelector('form').style.display = 'block'
        document.getElementById('loading').style.display = 'none'
      }

      // Debug log
      function debugLog(msg) {
        console.log('[Kitonga] ' + msg)
        if (DEBUG_MODE) {
          var debugDiv = document.getElementById('debugInfo')
          debugDiv.style.display = 'block'
          debugDiv.innerHTML += msg + '<br>'
        }
      }

      // Open registration page with router_id for tenant-specific bundles
      function openRegistration() {
        var params = getParams()
        var mac = params['mac'] || params['mac-address'] || ''
        var ip = params['ip'] || params['ip-address'] || ''

        var url = FRONTEND_URL + '?'
        if (ROUTER_ID) {
          url += 'router_id=' + encodeURIComponent(ROUTER_ID) + '&'
        }
        if (mac) {
          url += 'mac=' + encodeURIComponent(mac) + '&'
        }
        if (ip) {
          url += 'ip=' + encodeURIComponent(ip)
        }
        window.open(url, '_blank')
      }

      // Normalize phone number to 255 format (always prepend 255)
      function normalizePhone(phone) {
        // Remove all non-digit characters
        phone = phone.replace(/[^0-9]/g, '')

        // If user somehow entered full number with 255, extract the last 9 digits
        if (phone.length > 9) {
          phone = phone.substring(phone.length - 9)
        }

        // Always prepend 255
        return '255' + phone
      }

      // Validate phone number (must be exactly 9 digits)
      function validatePhone(phone) {
        var digitsOnly = phone.replace(/[^0-9]/g, '')
        return digitsOnly.length === 9
      }

      // Handle form submission
      function doLogin() {
        var username = document.getElementById('username').value.trim()
        var params = getParams()

        // Validation - must be exactly 9 digits
        if (!username) {
          showError('Please enter your phone number')
          return false
        }

        // Remove any non-digits and check length
        var digitsOnly = username.replace(/[^0-9]/g, '')

        if (digitsOnly.length !== 9) {
          showError('Please enter exactly 9 digits after +255 (e.g., 712345678)')
          return false
        }

        // Validate it starts with valid Tanzanian prefix (6, 7, or sometimes others)
        if (!digitsOnly.match(/^[1-9][0-9]{8}$/)) {
          showError('Please enter a valid Tanzanian phone number')
          return false
        }

        hideMessages()
        showLoading('Verifying your access...')

        // Get MikroTik parameters
        var mac = params['mac'] || params['mac-address'] || ''
        var ip = params['ip'] || params['ip-address'] || ''
        var routerId = params['router-id'] || params['router_id'] || params['routerid'] || ''
        var linkLogin = params['link-login'] || params['link_login'] || ''
        var linkOrig = params['link-orig'] || params['link_orig'] || params['dst'] || ''
        var chapId = params['chap-id'] || params['chap_id'] || ''
        var chapChallenge = params['chap-challenge'] || params['chap_challenge'] || ''

        debugLog('MAC: ' + mac + ', IP: ' + ip + ', Router: ' + ROUTER_ID)
        debugLog('Link-login: ' + linkLogin)

        // Normalize phone number
        var normalizedPhone = normalizePhone(username)
        debugLog('Phone: ' + username + ' -> ' + normalizedPhone)

        // Step 1: Verify access with backend API
        verifyAccessWithBackend(normalizedPhone, mac, ip, function (result) {
          if (result.success && result.access_granted) {
            // User has valid access - now submit to MikroTik
            showLoading('Access verified! Connecting to internet...')
            debugLog('Access granted, submitting to MikroTik')

            if (linkLogin) {
              // Submit credentials to MikroTik hotspot
              submitToMikrotik(normalizedPhone, normalizedPhone, linkLogin, chapId, chapChallenge, linkOrig)
            } else {
              // No link-login, just show success and redirect to portal
              hideLoading()
              showSuccess('Access granted! Redirecting to portal...')
              setTimeout(function () {
                window.location.href = FRONTEND_URL + '?phone=' + encodeURIComponent(normalizedPhone)
              }, 1500)
            }
          } else {
            // Access denied - redirect to portal for payment
            hideLoading()
            var reason = result.denial_reason || result.message || 'Access denied'
            showError(reason + '<br><br>Redirecting to payment portal...')
            debugLog('Access denied: ' + reason + ' - Redirecting to portal')

            // Redirect to portal with phone number and router_id pre-filled
            setTimeout(function () {
              var portalUrl = FRONTEND_URL + '?phone=' + encodeURIComponent(normalizedPhone)
              if (ROUTER_ID) {
                portalUrl += '&router_id=' + encodeURIComponent(ROUTER_ID)
              }
              if (mac) {
                portalUrl += '&mac=' + encodeURIComponent(mac)
              }
              if (ip) {
                portalUrl += '&ip=' + encodeURIComponent(ip)
              }
              window.location.href = portalUrl
            }, 2000)
          }
        })

        return false
      }

      // Verify access with backend API (uses global ROUTER_ID)
      function verifyAccessWithBackend(phone, mac, ip, callback) {
        var xhr = new XMLHttpRequest()
        xhr.open('POST', API_BASE_URL + '/api/verify/', true)
        xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.timeout = 15000

        xhr.onload = function () {
          try {
            var response = JSON.parse(xhr.responseText)
            debugLog('API Response: ' + JSON.stringify(response).substring(0, 200))
            callback({
              success: true,
              access_granted: response.access_granted,
              denial_reason: response.denial_reason,
              user: response.user,
              mikrotik_auto_login: response.mikrotik_auto_login
            })
          } catch (e) {
            debugLog('Parse error: ' + e.message)
            callback({
              success: false,
              access_granted: false,
              denial_reason: 'Failed to verify access. Please try again.'
            })
          }
        }

        xhr.onerror = function () {
          debugLog('Network error')
          callback({
            success: false,
            access_granted: false,
            denial_reason: 'Network error. Please check your connection.'
          })
        }

        xhr.ontimeout = function () {
          debugLog('Request timeout')
          callback({
            success: false,
            access_granted: false,
            denial_reason: 'Connection timeout. Please try again.'
          })
        }

        var payload = JSON.stringify({
          phone_number: phone,
          mac_address: mac,
          ip_address: ip,
          router_id: ROUTER_ID ? parseInt(ROUTER_ID) : null
        })

        debugLog('Sending to API: ' + payload)
        xhr.send(payload)
      }

      // Submit to MikroTik hotspot login
      function submitToMikrotik(username, password, loginUrl, chapId, chapChallenge, dst) {
        try {
          debugLog('Submitting to MikroTik: ' + loginUrl)

          // Build form
          var form = document.createElement('form')
          form.method = 'post'
          form.action = loginUrl

          // Add fields
          var fields = {
            username: username,
            password: password
          }

          // Add CHAP if available (for CHAP authentication)
          if (chapId) {
            fields['chap-id'] = chapId
          }
          if (chapChallenge) {
            fields['chap-challenge'] = chapChallenge
          }

          // Add destination
          if (dst) {
            fields['dst'] = dst
          }

          // Create hidden inputs
          for (var key in fields) {
            var input = document.createElement('input')
            input.type = 'hidden'
            input.name = key
            input.value = fields[key]
            form.appendChild(input)
          }

          showSuccess('Access granted! Connecting...')

          // Submit form after brief delay
          document.body.appendChild(form)
          setTimeout(function () {
            form.submit()
          }, 500)
        } catch (error) {
          debugLog('MikroTik submit error: ' + error.message)
          hideLoading()
          showError('Connection failed. Please try again or contact support.')
        }
      }

      // Initialize page
      function init() {
        var params = getParams()

        debugLog('URL params: ' + JSON.stringify(params))

        // Handle MikroTik error messages
        if (params.error) {
          var errorMsg = 'Authentication failed'
          switch (params.error) {
            case 'invalid username or password':
            case 'invalid-user':
              errorMsg = 'Invalid username or password. Please check your phone number.'
              break
            case 'user-session-limit':
              errorMsg = 'Maximum device limit reached. Please disconnect another device.'
              break
            case 'user-expired':
              errorMsg = 'Your access has expired. Please make a new payment.'
              break
            case 'radius-no-response':
              errorMsg = 'Server connection error. Please try again.'
              break
            default:
              errorMsg = 'Login failed: ' + params.error
          }
          showError(errorMsg)
        }

        // Set hidden fields
        var dstInput = document.querySelector('input[name="dst"]')
        var popupInput = document.querySelector('input[name="popup"]')
        if (dstInput) dstInput.value = params.dst || params['link-orig'] || ''
        if (popupInput) popupInput.value = params.popup || ''

        // Focus username
        document.getElementById('username').focus()

        // Show debug info if enabled
        if (DEBUG_MODE) {
          document.getElementById('debugInfo').style.display = 'block'
          debugLog('Page loaded')
          debugLog('API URL: ' + API_BASE_URL)
        }
      }

      // Run on page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init)
      } else {
        init()
      }
    </script>
  </body>
</html>
